CREATE OR REPLACE VIEW %dbprefix%view_contact_email AS SELECT contact_id,detail email FROM %dbprefix%contact_details WHERE type = 'email';
CREATE OR REPLACE VIEW %dbprefix%view_email AS SELECT contact_id,group_concat(detail) AS emails FROM %dbprefix%contact_details WHERE type = 'email' GROUP BY contact_id;
CREATE OR REPLACE VIEW %dbprefix%view_visit_treatments AS SELECT visit.visit_id,bill_detail.particular,bill_detail.type FROM %dbprefix%visit AS visit LEFT JOIN %dbprefix%bill AS bill ON bill.visit_id = visit.visit_id LEFT JOIN %dbprefix%bill_detail AS bill_detail ON bill_detail.bill_id = bill.bill_id;
CREATE OR REPLACE VIEW %dbprefix%view_patient AS SELECT patient.ssn_id,patient.is_inquiry,patient.inquiry_reason,patient.sync_status,patient.is_deleted, patient.erpnext_key,patient.patient_id AS patient_id,patient.clinic_id AS clinic_id,patient.blood_group AS blood_group,patient.clinic_code AS clinic_code,patient.patient_since AS patient_since,patient.age AS age,patient.display_id AS display_id,patient.gender AS gender,patient.dob AS dob,patient.reference_by AS reference_by,patient.reference_by_detail AS reference_by_detail,patient.followup_date AS followup_date,((select ifnull(sum(ifnull(patient_account.adjust_amount,0)),0) from %dbprefix%patient_account patient_account where ((patient_account.patient_id = patient.patient_id) and (patient_account.payment_id is not null))) - (select ifnull(sum(ifnull(patient_account.adjust_amount,0)),0) from %dbprefix%patient_account patient_account where ((patient_account.patient_id = patient.patient_id) and (patient_account.bill_id is not null)))) AS in_account_amount,contacts.display_name AS display_name,contacts.contact_id AS contact_id,contacts.title AS title,contacts.first_name AS first_name,contacts.middle_name AS middle_name,contacts.last_name AS last_name,CONCAT(IFNULL(contacts.title,''),' ',IFNULL(contacts.first_name,''),' ',IFNULL(contacts.middle_name,''),' ',IFNULL(contacts.last_name,'')) AS patient_name,(select contact_details.detail from %dbprefix%contact_details contact_details where ((contact_details.contact_id = contacts.contact_id) and (contact_details.type = 'mobile')) limit 1) AS phone_number,contacts.email AS email from (%dbprefix%patient patient left join %dbprefix%contacts contacts on((patient.contact_id = contacts.contact_id))) ;
CREATE OR REPLACE VIEW %dbprefix%view_doctor  AS  select concat(ifnull(contacts.title,''),' ',ifnull(contacts.first_name,''),' ',ifnull(contacts.middle_name,''),' ',ifnull(contacts.last_name,'')) AS name,users.centers AS centers,contacts.title AS title,contacts.first_name AS first_name,contacts.middle_name AS middle_name,contacts.last_name AS last_name,doctor.doctor_id AS doctor_id,doctor.userid AS userid,doctor.degree AS degree,doctor.specification AS specification,doctor.experience AS experience,doctor.joining_date AS joining_date,doctor.licence_number AS licence_number,doctor.department_id AS department_id,doctor.gender AS gender,doctor.description AS description,doctor.dob AS dob,doctor.contact_id AS contact_id from ((%dbprefix%doctor doctor join %dbprefix%contacts contacts on((contacts.contact_id = doctor.contact_id))) join %dbprefix%users users on((users.userid = doctor.userid))) ;
CREATE OR REPLACE VIEW %dbprefix%view_report AS SELECT appointment.appointment_id AS appointment_id,appointment.patient_id AS patient_id,appointment.clinic_code AS clinic_code,CONCAT(IFNULL(view_patient.first_name,''),' ',IFNULL(view_patient.middle_name,''),' ',IFNULL(view_patient.last_name,'')) AS patient_name,appointment.doctor_id AS doctor_id,appointment.clinic_id AS clinic_id,appointment.status AS status,clinic.clinic_name AS clinic_name,CONCAT(IFNULL(contacts.first_name,''),' ',IFNULL(contacts.middle_name,''),' ',IFNULL(contacts.last_name,'')) AS doctor_name,appointment.appointment_date AS appointment_date,MIN(appointment.start_time) AS appointment_time,MAX((CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END)) AS waiting_in,(MAX((CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END)) - MAX((CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END))) AS waiting_duration,MAX((CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END)) AS consultation_in,MAX((CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END)) AS consultation_out,(MAX((CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END)) - MAX((CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END))) AS consultation_duration,MAX((CASE appointment_log.old_status WHEN 'Consultation' THEN timediff(appointment_log.to_time,appointment_log.from_time) END)) AS waiting_out,MAX(bill.total_amount) AS collection_amount FROM %dbprefix%appointments appointment LEFT JOIN %dbprefix%view_patient view_patient  ON appointment.patient_id = view_patient.patient_id LEFT JOIN %dbprefix%bill bill ON appointment.visit_id = bill.visit_id LEFT JOIN %dbprefix%appointment_log appointment_log ON appointment.appointment_id = appointment_log.appointment_id LEFT JOIN %dbprefix%doctor doctor ON doctor.doctor_id = appointment.doctor_id LEFT JOIN %dbprefix%contacts contacts ON contacts.contact_id = doctor.contact_id LEFT JOIN %dbprefix%clinic clinic ON clinic.clinic_id = appointment.clinic_id GROUP BY appointment.appointment_id,CONCAT(IFNULL(view_patient.first_name,''),' ',IFNULL(view_patient.middle_name,''),' ',IFNULL(view_patient.last_name,'')) ;
CREATE OR REPLACE VIEW %dbprefix%view_bill_payment_r AS SELECT payment.pay_date,       bill_payment_r.bill_id,	   bill_payment_r.adjust_amount,	   payment.payment_id  FROM %dbprefix%payment AS payment       JOIN %dbprefix%bill_payment_r AS bill_payment_r ON bill_payment_r.payment_id = payment.payment_id;
CREATE OR REPLACE VIEW %dbprefix%view_bill_detail_report  AS SELECT bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.visit_id AS visit_id,bill_detail.particular AS particular,bill_detail.amount AS amount,bill_detail.tax_amount AS tax_amount,visit.userid AS userid,CONCAT(view_patient.first_name,' ',view_patient.middle_name,' ',view_patient.last_name) AS patient_name,view_patient.display_id AS display_id,bill_detail.type AS type FROM %dbprefix%bill bill LEFT JOIN %dbprefix%bill_detail bill_detail ON bill_detail.bill_id = bill.bill_id LEFT JOIN %dbprefix%visit visit ON visit.visit_id = bill.visit_id LEFT JOIN %dbprefix%view_patient view_patient ON view_patient.patient_id = bill.patient_id WHERE IFNULL(bill_detail.is_deleted,0) <> 1;
CREATE OR REPLACE VIEW %dbprefix%view_bill_tax_report AS select patient.display_id AS display_id, patient.first_name AS first_name,patient.middle_name AS middle_name,patient.last_name AS last_name,bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.total_amount AS total_amount,SUM(bill_detail.amount) AS tax_amount from %dbprefix%bill bill  join %dbprefix%view_patient patient on patient.patient_id = bill.patient_id left join %dbprefix%bill_detail bill_detail on bill_detail.bill_id = bill.bill_id AND bill_detail.type='tax' group by bill.bill_id;
CREATE OR REPLACE VIEW %dbprefix%view_tax_report AS select patient.display_id AS display_id,patient.first_name AS first_name,patient.middle_name AS middle_name,patient.last_name AS last_name,bill.bill_id AS bill_id,bill.bill_date AS bill_date,(SELECT SUM(IFNULL(bill_detail_tax.amount,0)) FROM %dbprefix%bill_detail bill_detail_tax WHERE bill_detail_tax.bill_id = bill.bill_id and ifnull(bill_detail_tax.tax_amount,0) > 0) AS taxable_amount,(SELECT SUM(IFNULL(bill_detail_non.amount,0)) FROM %dbprefix%bill_detail bill_detail_non WHERE bill_detail_non.bill_id = bill.bill_id and ifnull(bill_detail_non.tax_amount,0) = 0 and bill_detail_non.type != 'discount') AS non_taxable_amount,(SELECT SUM(IFNULL(bill_detail_discount.amount,0)) FROM %dbprefix%bill_detail bill_detail_discount WHERE bill_detail_discount.bill_id = bill.bill_id and bill_detail_discount.type = 'discount') AS discount,bill.tax_amount AS item_tax_amount,bill.total_amount AS total_amount from %dbprefix%bill bill  join %dbprefix%view_patient patient on patient.patient_id = bill.patient_id;
CREATE OR REPLACE VIEW %dbprefix%view_payment  AS  select distinct payment.payment_id AS payment_id,payment.clinic_id AS clinic_id,payment.pay_date AS pay_date,payment.pay_mode AS pay_mode,payment.payment_status,payment.additional_detail AS additional_detail,payment.pay_amount AS pay_amount,patient.patient_id AS patient_id,patient.display_id AS display_id,contacts.first_name AS first_name,contacts.middle_name AS middle_name,contacts.last_name AS last_name from ((%dbprefix%payment payment join %dbprefix%patient patient on((patient.patient_id = payment.patient_id))) join %dbprefix%contacts contacts on((contacts.contact_id = patient.contact_id))) ;
CREATE OR REPLACE VIEW %dbprefix%view_visit  AS  select visit.visit_id AS visit_id,visit.visit_date AS visit_date,visit.visit_time AS visit_time,visit.appointment_reason AS appointment_reason,visit.type AS type,visit.notes AS notes,visit.patient_notes AS patient_notes,visit.doctor_id AS doctor_id,doctor.name AS name,visit.patient_id AS patient_id,patient.reference_by AS reference_by,patient.reference_by_detail AS reference_by_detail,bill.bill_id AS bill_id,bill.total_amount AS total_amount,(select ifnull(sum(ifnull(bill_detail.amount,0)),0) from %dbprefix%bill_detail bill_detail where ((bill_detail.bill_id = bill.bill_id) and (bill_detail.type = 'tax'))) AS bill_tax_amount,(select sum(item_bill_detail.tax_amount) from %dbprefix%bill_detail item_bill_detail where (item_bill_detail.bill_id = bill.bill_id)) AS item_tax_amount,bill.due_amount AS due_amount from %dbprefix%visit visit join %dbprefix%view_doctor doctor on doctor.doctor_id = visit.doctor_id join %dbprefix%patient patient on patient.patient_id = visit.patient_id join %dbprefix%bill bill on bill.visit_id = visit.visit_id order by visit.patient_id,visit.visit_date,visit.visit_time ;
CREATE OR REPLACE VIEW %dbprefix%view_bill  AS select bill.bill_id AS bill_id, bill.bill_date AS bill_date,doctor.name AS doctor_name,ifnull(visit.doctor_id,bill.doctor_id) AS doctor_id,	   patient.patient_id AS patient_id,	   contacts.first_name AS first_name,	   contacts.middle_name AS middle_name,	   contacts.last_name AS last_name,	   bill.total_amount AS total_amount,	   bill.due_amount AS due_amount,	   sum(bill_payment_r.adjust_amount) AS pay_amount  from  %dbprefix%bill bill        left join %dbprefix%patient patient on bill.patient_id = patient.patient_id   left join %dbprefix%contacts contacts on contacts.contact_id = patient.contact_id	   left join %dbprefix%visit visit on bill.visit_id = visit.visit_id	   left join %dbprefix%bill_payment_r bill_payment_r on bill.bill_id = bill_payment_r.bill_id	   left join %dbprefix%view_doctor doctor on ifnull(visit.doctor_id,bill.doctor_id) = doctor.doctor_id group by bill.bill_id,bill.bill_date,doctor.name,ifnull(visit.doctor_id,bill.doctor_id);
CREATE OR REPLACE VIEW %dbprefix%view_doctor  AS SELECT concat(ifnull(contacts.title,''),' ',ifnull(contacts.first_name,''),' ',ifnull(contacts.middle_name,''),' ',ifnull(contacts.last_name,'')) AS name, users.centers AS centers, contacts.title AS title, contacts.first_name AS first_name, contacts.middle_name AS middle_name, contacts.last_name AS last_name, doctor.doctor_id AS doctor_id, doctor.userid AS userid, users.is_deleted as is_deleted , doctor.degree AS degree, doctor.specification AS specification, doctor.experience AS experience, doctor.joining_date AS joining_date, doctor.licence_number AS licence_number, doctor.department_id AS department_id, doctor.gender AS gender, doctor.description AS description, doctor.dob AS dob, doctor.contact_id AS contact_id FROM ((%dbprefix%doctor doctor join %dbprefix%contacts contacts on(contacts.contact_id = doctor.contact_id)) join %dbprefix%users users on(users.userid = doctor.userid)) WHERE IFNULL(doctor.is_deleted,0) != 1 AND  IFNULL(users.is_deleted,0) != 1 ;
CREATE OR REPLACE VIEW %dbprefix%view_doctor  AS select concat(ifnull(contacts.title,''),' ',convert(ifnull(contacts.first_name,'') using utf8mb4),' ',convert(ifnull(contacts.middle_name,'') using utf8mb4),' ',convert(ifnull(contacts.last_name,'') using utf8mb4)) AS name,users.centers AS centers,users.is_active AS is_active,contacts.title AS title,contacts.first_name AS first_name,contacts.middle_name AS middle_name,contacts.last_name AS last_name,doctor.doctor_id AS doctor_id,doctor.userid AS userid,users.is_deleted AS is_deleted,doctor.degree AS degree,doctor.specification AS specification,doctor.experience AS experience,doctor.joining_date AS joining_date,doctor.licence_number AS licence_number,doctor.department_id AS department_id,doctor.gender AS gender,doctor.description AS description,doctor.dob AS dob,doctor.contact_id AS contact_id from ((%dbprefix%doctor doctor join %dbprefix%contacts contacts on((contacts.contact_id = doctor.contact_id))) join %dbprefix%users users on((users.userid = doctor.userid))) where ((ifnull(doctor.is_deleted,0) <> 1) and (ifnull(users.is_deleted,0) <> 1));
CREATE OR REPLACE VIEW %dbprefix%view_bill  AS select bill.bill_id AS bill_id, bill.bill_date AS bill_date,doctor.name AS doctor_name,ifnull(visit.doctor_id,bill.doctor_id) AS doctor_id,	   patient.patient_id AS patient_id,
	    patient.display_id AS display_id, contacts.first_name AS first_name,
        contacts.middle_name AS middle_name,	   contacts.last_name AS last_name,
        bill.total_amount AS total_amount,	   
        bill.due_amount AS due_amount,	  
        (SELECT  IFNULL(SUM(bill_detail.tax_amount),0) FROM %dbprefix%bill_detail AS bill_detail WHERE bill_detail.bill_id = bill.bill_id ) AS item_tax_amount,	 
       	SUM(IF(payment.payment_status != "rejected",bill_payment_r.adjust_amount,0)) AS pay_amount,
        (SELECT view_visit.bill_tax_amount FROM %dbprefix%view_visit view_visit WHERE bill.visit_id = view_visit.visit_id ) as bill_tax_amount
        from  %dbprefix%bill bill        
        left join %dbprefix%patient patient on bill.patient_id = patient.patient_id   
        left join %dbprefix%contacts contacts on contacts.contact_id = patient.contact_id	   
        left join %dbprefix%visit visit on bill.visit_id = visit.visit_id	   
        left join %dbprefix%bill_payment_r bill_payment_r on bill.bill_id = bill_payment_r.bill_id	
        LEFT JOIN %dbprefix%payment payment ON payment.payment_id = bill_payment_r.payment_id   
        left join %dbprefix%view_doctor doctor on ifnull(visit.doctor_id,bill.doctor_id) = doctor.doctor_id
        group by bill.bill_id,bill.bill_date,doctor.name,ifnull(visit.doctor_id,bill.doctor_id);
